name: Pre-Commit Checks

on:
  push:
    branches:
      - main
      - develop
      - 'feat/**'
      - 'feature/**'
      - 'test/**'
      - 'chore/**'
      - 'fix/**'
      - 'hotfix/**'
      - 'docs/**'
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

jobs:
  precommit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for pre-commit to compare against base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Load Pre-commit Config
        run: |
          if [ ! -f ".pre-commit-config.yaml" ]; then
            echo "‚ö†Ô∏è  No .pre-commit-config.yaml found ‚Äî downloading BerryBytes global config..."
            curl -sSL \
              https://raw.githubusercontent.com/BerryBytes/precommit-util/main/global/precommitFile/.pre-commit-config.yaml \
              -o .pre-commit-config.yaml
          else
            echo "‚úî Using project's existing .pre-commit-config.yaml"
          fi

      - name: Inject temporary Stylelint config for CI
        run: |
          if [ ! -f ".stylelintrc.json" ]; then
            echo "‚ö†Ô∏è  Creating temporary .stylelintrc.json for CI..."
            cat <<'EOF' > .stylelintrc.json
          {
            "extends": "stylelint-config-standard",
            "rules": {
              "no-duplicate-selectors": true,
              "color-hex-length": "short",
              "selector-no-qualifying-type": true,
              "selector-max-id": 0
            }
          }
          EOF
          else
            echo "‚úî .stylelintrc.json already exists ‚Äî skipping"
          fi

      - name: Run pre-commit checks
        id: precommit
        continue-on-error: true
        run: |
          echo "üîç Running pre-commit checks..."
          pre-commit run --all-files --show-diff-on-failure --color=always 2>&1 | tee precommit_output.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Generate summary
        if: always()
        run: |
          EXIT_CODE="${{ steps.precommit.outputs.exit_code }}"
          
          echo "====================================================="
          echo "üîç PRE-COMMIT RESULTS SUMMARY"
          echo "====================================================="
          echo ""

          if [ "$EXIT_CODE" = "0" ]; then
            echo "‚úÖ All pre-commit hooks passed!"
            echo ""
            echo "**Status**: Success ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All pre-commit checks completed successfully." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "‚ùå Pre-commit checks failed"
          echo ""

          # Add to GitHub summary
          echo "**Status**: Failed ‚ùå" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Failed Hooks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract failed hooks
          if grep -q "Failed" precommit_output.log; then
            echo "üìã FAILED HOOKS:"
            grep -E "^[a-zA-Z].*\.(Failed|\.+Failed)" precommit_output.log | while read -r line; do
              echo "  ‚ùå $line"
              echo "- \`$line\`" >> $GITHUB_STEP_SUMMARY
            done
            echo ""
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Extract modified files
          if grep -q "files were modified" precommit_output.log; then
            echo "üìù FILES MODIFIED BY HOOKS:"
            echo "## Modified Files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            grep -A 20 "files were modified" precommit_output.log | \
              grep -E "^\s*-\s" | head -20 | while read -r file; do
              echo "  $file"
              echo "$file" >> $GITHUB_STEP_SUMMARY
            done
            echo ""
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Extract error messages
          if grep -Eiq "(error|warning|violation)" precommit_output.log; then
            echo "‚ö†Ô∏è  ERROR DETAILS:"
            echo "## Error Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            grep -Ei "(error|warning|violation|line too long|missing)" precommit_output.log | \
              grep -Ev "^(---|\+\+\+|@@|diff --git|index )" | \
              head -50 | while read -r err; do
              echo "  ‚Ä¢ $err"
              echo "$err" >> $GITHUB_STEP_SUMMARY
            done
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo ""
          fi

          echo "====================================================="
          echo "üí° To fix locally, run: pre-commit run --all-files"
          echo "====================================================="
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üí° **To fix locally**: Run \`pre-commit run --all-files\`" >> $GITHUB_STEP_SUMMARY

          exit "$EXIT_CODE"

      - name: Upload pre-commit logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: precommit-logs
          path: precommit_output.log
          retention-days: 7